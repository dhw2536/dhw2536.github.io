---
layout:     post
title:      ROS - 8.SLAM技术与地图处理
subtitle:   ROS中的SLAM（同时定位与地图创建）技术，包括SLAM的基本概念、Hector Mapping和Gmapping的使用、TF系统的作用、里程计的重要性以及如何保存和加载地图。
date:       2024-11-09
author:     Space
header-img: img/the-first.png
catalog:   true
tags:
    - ROS


---



# 机器人操作系统 ROS 

### 41. 什么是SLAM

**1. SLAM定义**

- **全称**：Simultaneous Localization and Mapping（同时定位与地图创建）
- **核心内容**：
  - **Localization（定位）**：确定机器人在环境中的位置。
  - **Mapping（建图）**：创建环境的地图。

**2. 定位过程**

- **个人定位类比**：
  - 通过观察周围环境中的显著地标（如红绿灯、车辆等）来确定自己的位置。
  - 忽略细节，只关注关键特征。

**3. 建图过程**

- **地标与参照物**：
  - 使用显著特征（如红绿灯、车辆、垃圾箱等）作为参照物。
  - 通过观察参照物的位置和相互关系来构建地图。

**4. 地图的扩展**

- **观测与记录**：
  - 每次移动到新位置时，记录新参照物的位置。
  - 将新位置的局部地图与之前的地图进行匹配和拼接。

**5. SLAM在实际应用中的例子**

- **自动驾驶与机器人导航**：
  - 通过观测和记录环境特征，构建地图并进行导航。

**6. 激光雷达SLAM**

- **山格地图**：
  - 使用激光雷达扫描环境，将环境栅格化。
  - 初始状态：未知区域（灰色，数值-1）。
  - 扫描过程：激光雷达扫描并标记障碍物（黑色，数值100）和无障碍区域（白色，数值0）。

**7. 地图拼接**

- **特征匹配**：
  - 通过匹配障碍物的排布形状来拼接局部地图。
  - 逐步扩展地图，形成全局地图。

**8. 地图的最终形态**

- **全局地图**：
  - 包含障碍物分布和无障碍区域。
  - 用于导航和路径规划。

**9. 后续应用**

- **导航与路径规划**：
  - 利用构建的地图进行路径规划和导航。

**10. 总结**

- SLAM技术结合了定位和建图，通过观察环境中的关键特征来构建地图，并用于导航和路径规划。在自动驾驶和机器人领域有广泛应用。



### 42. Hector_Mapping初体验

**1. SLAM实现概述**

- **目的**：在ROS（Robot Operating System）中实现SLAM（Simultaneous Localization and Mapping）。
- **方法**：利用ROS的现成SLAM模块，避免从零编写算法。

**2. 功能节点规划**

- **激光雷达驱动节点**：发布雷达数据话题 `scan`。
- **SLAM节点**：
  - 订阅 `scan` 话题获取激光雷达数据。
  - 发布地图数据话题，用于显示地图。

**3. SLAM软件包选择**

- **软件包**：`hector_slam`。
- **特点**：免费且开源，适用于ROS环境。

**4. `hector_slam` 介绍**

- **视频演示**：展示了使用激光雷达进行SLAM的过程，无需额外传感器。
- **功能**：通过激光雷达数据生成地图。

**5. `hector_slam` 的输入输出接口**

- **输入**：
  - 订阅 `scan` 话题（激光雷达数据）。
  - 订阅 `system command` 话题（用于接收重置指令，通常不需要）。
- **输出**：
  - 发布 `map` 话题（包含地图数据）。
  - 发布 `map_meta_data` 话题（地图的描述信息）。
  - 发布原始和矫正后的机器人定位信息。

**6. 安装 `hector_slam`**

- **命令**：`sudo apt-get install ros-noetic-hector-slam`

**7. 运行SLAM节点**

- **启动仿真环境**：`roslaunch wpr_simulation wbstage.sdf.launch`
- **运行SLAM节点**：`rosrun hector_slam hector_mapping`

**8. 地图可视化**

- **使用RViz**：
  - 添加机器人模型。
  - 添加激光雷达扫描点。
  - 添加地图显示。

**9. 机器人控制**

- **使用**：`rqt_robot_steering` 工具控制机器人移动。

**10. 地图构建过程**

- **操作**：通过控制机器人在环境中移动，利用激光雷达数据构建地图。
- **结果**：生成完整的地图，用于后续的导航和路径规划。

**11. 总结**

- **实现**：通过ROS的 `hector_slam` 软件包，实现了SLAM功能，避免了复杂的算法开发。
- **应用**：生成的地图可用于机器人的导航和路径规划。

通过这些步骤，可以在ROS环境中快速实现SLAM功能，为机器人提供导航和路径规划的能力。



### 43. launch启动Hector_Mapping

**1. 概述**

- **目的**：通过创建Launch文件简化SLAM（Simultaneous Localization and Mapping）的运行过程。
- **工具**：ROS（Robot Operating System）。

**2. 创建软件包**

- **命令**：在catkin工作空间的`src`文件夹中创建新的软件包`slam_package`。

  ```bash
  cd ~/catkin_ws/src
  catkin_create_pkg slam_package roscpp std_msgs
  ```

**3. 创建Launch文件夹和文件**

- **操作**：在`slam_package`软件包中创建`launch`文件夹，并在其中创建Launch文件`hector.launch`。

**4. 编写Launch文件**

- **结构**：使用`<launch>`标签定义Launch文件。

- **包含其他Launch文件**：

  ```xml
  <launch>
    <include file="$(find wpr_simulation)/path/to/other/launch/file.launch" />
    <!-- 其他节点 -->
  </launch>
  ```

- **节点运行指令**：

  ```xml
  <node name="hector_mapping" pkg="hector_slam" type="hector_mapping" output="screen" />
  ```

**5. 编译软件包**

- **命令**：在catkin工作空间目录下执行编译命令。

  ```bash
  cd ~/catkin_ws
  catkin_make
  ```

**6. 运行Launch文件**

- **命令**：

  ```bash
  roslaunch slam_package hector.launch
  ```

**7. 使用RViz可视化**

- **步骤**：
  1. 配置RViz以显示SLAM地图。
  2. 保存RViz配置为文件`slam.rviz`。
  3. 在Launch文件中加载RViz配置文件。

**8. 保存RViz配置**

- **操作**：在RViz中配置好显示选项后，保存配置到`slam_package`的`rviz`文件夹中。

**9. 运行带有RViz配置的Launch文件**

- **命令**：

  ```bash
  roslaunch slam_package hector.launch
  ```

**10. 运行实体机器人上的SLAM**

- **方法**：
  - 替换Launch文件中的仿真环境启动指令为实体机器人的启动指令。
  - 或者只启动激光雷达，手动移动机器人进行建图。

**11. 检查和调试**

- **参考**：如果遇到问题，可以查看`wpr_simulation`软件包中的`hector_mapping.launch`文件作为参考。

**12. 总结**

- **成果**：通过编写和运行Launch文件，简化了SLAM的运行过程，实现了快速启动和配置。
- **应用**：这种方法适用于仿真环境和实体机器人，提高了开发和测试的效率。



### 44. Hecotr_Mapping的参数设置

**1. 概述**

- **目的**：学习如何在ROS的Launch文件中为`hector_slam`设置参数。

**2. 查找参数**

- **方法**：在ROS Index中搜索`hector_slam`，进入Wiki页面，查找`3.1.4 Parameters`部分。

**3. 选择参数**

- **参数列表**：参数名、类型、默认值和说明。
- **选择**：选择几个易于观察效果的参数进行设置。

**4. 选定参数**

- **map_update_distance_thresh**：地图更新的距离阈值。
- **map_update_angle_thresh**：地图更新的角度阈值。
- **map_publish_period**：地图发布的时间周期。

**5. 修改Launch文件**

- **工具**：使用VS Code打开并编辑Launch文件。
- **步骤**：
  - 找到`hector_mapping`节点标签。
  - 调整节点标签，添加结束标签。
  - 在节点内部添加`<param>`标签设置参数。

**6. 设置参数值**

- **map_update_distance_thresh**：设置为0.1米（默认0.4米）。
- **map_update_angle_thresh**：设置为0.1弧度（默认0.9弧度）。
- **map_publish_period**：设置为0.1秒（默认2秒）。

**7. 保存并运行**

- **保存**：使用`CTRL+S`保存Launch文件。
- **运行**：在终端中运行修改后的Launch文件。

**8. 观察效果**

- **方法**：通过调整界面和控制器，观察地图更新是否变快。

**9. 对比参数效果**

- **方法**：在同一场景中运行两个`hector_slam`节点，设置不同的参数。
- **步骤**：
  - 打开`wpr_simulation`的Launch文件。
  - 设置不同参数值。
  - 保存并运行Launch文件。

**10. 观察对比**

- **操作**：调整RViz窗口，观察不同参数设置下的地图更新效果。

**11. 实验建议**

- **建议**：尝试设置更多参数，选择不同的数值，对比最终的建图效果。

**12. 应用准备**

- **目的**：通过实验了解每个参数的作用，为将来在实体机器人上应用做准备。

**13. 总结**

- **成果**：通过修改Launch文件中的参数，可以调整SLAM过程中地图的更新频率和发布周期，从而优化建图效果。
- **应用**：这种方法有助于在仿真环境中快速测试和调整SLAM参数，为实体机器人的应用提供参考。



### 45. 初识ROS的TF系统

**1. SLAM与定位信息**

- **SLAM全称**：Simultaneous Localization and Mapping（同时定位与建图）。
- **定位信息描述**：描述机器人相对于地图坐标系原点的空间关系。

**2. 坐标系定义**

- **地图坐标系（map）**：原点在机器人建图初始位置，遵循ROS的右手法则。
- **机器人坐标系（base_link）**：原点在机器人底盘投影到地面的中心位置，遵循右手法则。

**3. 空间关系描述**

- **位置**：通过XYZ轴上的距离偏移量描述。
- **方向**：通过角度偏差值描述，对于地面移动机器人，主要是Z轴的朝向角。

**4. 获取定位数值**

- **TF系统**：Transform，描述两个坐标系之间的空间关系。
- **消息包**：特定ROS节点发布TF关系消息到TF话题。

**5. RViz中的TF显示**

- **操作**：在RViz中添加TF显示项目，查看地图和机器人的相对位置。
- **坐标轴**：修改显示大小，只保留`base_link`和`map`坐标系。

**6. 查看TF具体数值**

- **命令**：`rostopic list` 查看包含TF数据的话题。
- **消息类型**：`rostopic info /tf` 查看TF话题的消息格式。
- **数据结构**：TransformStamped类型数组，包含多个坐标系的空间关系。

**7. TF消息包内容**

- **translation**：XYZ三个浮点数，描述子坐标系在父坐标系中的距离偏移量。
- **rotation**：四元数，描述子坐标系相对于父坐标系的角度偏差。

**8. 查看TF消息**

- **命令**：`rostopic echo /tf` 查看TF话题中的实时消息。
- **TF消息**：包含不同时刻坐标系的空间关系，随机器人移动不断变化。

**9. 理解TF层级关系**

- **工具**：`rosrun rqt_tf_tree rqt_tf_tree` 显示TF树。
- **TF树**：显示坐标系的层级关系，形似倒置的家族族谱。

**10. TF系统的应用**

- **重要性**：对于SLAM建图和导航至关重要。
- **用途**：TF系统的应用不仅限于定位，还有更广泛的用途。

**11. 总结**

- **TF系统**：在ROS中用于描述和查询不同坐标系之间的空间关系。
- **SLAM定位**：通过TF系统获取机器人在地图中的定位信息，对机器人导航和路径规划至关重要。



### 46. 里程计在激光雷达 SLAM 中的作用

**1. TF系统回顾**

- **介绍**：在ROS中，TF系统用于描述和跟踪多个坐标系之间的变换关系。

**2. 坐标系关系**

- **观察**：在运行SLAM时，`map`与`base_link`之间通过`odom`连接，表示里程计输出。

**3. 建图方法对比**

- **方法一**：使用`hector_slam`在直线走廊场景中建图，出现定位问题。
- **方法二**：使用`gmapping`在同一场景中建图，顺利完成任务。

**4. 环境对建图的影响**

- **问题**：在直线走廊中，由于缺少特征点，激光雷达难以检测机器人的移动。
- **解决方案**：通过轮子转动计算机器人的位移，即电机里程计（odometry）。

**5. 电机里程计（Odometry）**

- **定义**：通过电机转速计算机器人位移的算法。
- **应用**：在驱动节点中运行，发布TF消息包到TF话题。

**6. 里程计与SLAM的关系**

- **区别**：里程计提供基于轮子转动的位移信息，而SLAM通过环境特征进行定位。
- **结合**：里程计的位移信息可被SLAM算法用来修正定位误差。

**7. `gmapping`与`hector_slam`的区别**

- **`gmapping`**：主要通过里程计推算位移，激光雷达用于修正误差。
- **`hector_slam`**：不考虑里程计数据，只使用激光雷达与障碍物配准进行定位。

**8. 里程计在SLAM中的作用**

- **重要性**：在特征缺失的环境中，里程计帮助SLAM算法维持连续的定位。

**9. 实际场景测试**

- **测试**：在直线走廊环境中测试两种SLAM算法。
- **结果**：`gmapping`通过里程计修正误差，而`hector_slam`显示里程计误差累积。

**10. 里程计的局限性**

- **问题**：里程计的计算结果可能因轮子打滑而产生偏差。

**11. 定位信息的修正**

- **方法**：使用激光雷达点云与障碍物配准算法修正里程计的误差。

**12. 总结**

- **TF系统**：在ROS中用于跟踪坐标系变换，对SLAM和导航至关重要。
- **里程计**：提供连续的位移信息，有助于在特征缺失环境中维持定位。
- **SLAM算法**：不同算法有不同的处理方式，结合里程计和环境特征进行优化。

**13. 工程实践建议**

- **观察**：在实际应用中注意里程计和SLAM算法的结合使用。
- **总结**：将这些概念应用到自己的项目中，提高机器人系统的稳定性和准确性。



### 47. Gmapping的使用

**1. gmapping简介**

- **节点名**：`slam_gmapping`
- **功能**：一种SLAM（Simultaneous Localization and Mapping）建图方法。

**2. gmapping所需数据**

- **数据来源**：
  - 订阅`scan`话题获取激光雷达数据。
  - 订阅`tf`话题获取坐标系转换关系。

**3. 必需的TF关系**

- **雷达坐标系到底盘坐标系**：`<laser>`到`base_link`的TF。
  - `<laser>`名称需与激光雷达数据包中的`frame_id`一致。
- **底盘坐标系到里程计**：`base_link`到`odom`的TF。

**4. 运行前的检查**

- **步骤**：
  1. 确认`scan`话题存在。
  2. 确认必需的TF关系存在。

**5. gmapping输出**

- **输出话题**：
  1. 地图信息。
  2. 占用网格地图数据。
  3. 机器人定位的置信度。
  4. `map`到`odom`的TF关系。

**6. 运行仿真环境**

- **命令**：`roslaunch wpr_simulation wpb_stage_cup.launch`。
- **场景**：模拟家庭服务机器人比赛场景。

**7. 确认输入数据**

- **操作**：
  1. 通过`rostopic list`确认`scan`话题存在。
  2. 通过`rosrun rqt_tf_tree rqt_tf_tree`确认TF关系存在。

**8. 运行gmapping**

- **操作**：
  1. 启动gmapping节点。
  2. 观察RViz中地图的生成。

**9. RViz配置**

- **添加显示**：
  1. 机器人模型。
  2. 激光雷达测距点。
  3. 地图数据。

**10. 控制机器人移动**

- **工具**：`rosrun wpr_simulation keyboard_teleop`。
- **操作**：
  - 使用键盘控制机器人移动，扫描整个环境。

**11. 完成建图**

- **结果**：成功创建环境地图。

**12. 后续内容预告**

- **预告**：下一节将介绍如何编写Launch文件来启动gmapping建图。

**13. 总结**

- **gmapping**：一种有效的SLAM建图工具，通过订阅激光雷达数据和TF关系，输出地图和定位信息。
- **操作流程**：确认输入数据，运行gmapping，调整RViz配置，控制机器人移动，完成建图。



### 48. launch启动Gmapping建图

**1. 新建软件包**

- **命令**：在catkin工作空间的`src`目录下创建名为`slam_package`的软件包。

  ```bash
  cd ~/catkin_ws/src
  catkin_create_pkg slam_package roscpp rospy std_msgs
  ```

**2. 创建Launch文件夹和文件**

- **操作**：在`slam_package`软件包中创建`launch`文件夹，并在其中创建`gmapping.launch`文件。

**3. 编写Launch文件**

- **步骤**：
  1. 使用`<launch>`标签定义最外层的容器。
  2. 使用`<include>`标签引入`wpr_simulation`的launch文件。
  3. 使用`<node>`标签定义gmapping节点和其他相关节点。

**4. 节点配置**

- **软件包**：`gmapping`
- **节点名**：`slam_gmapping`
- **运行实例名**：`slam_gmapping`

**5. 保存并编译**

- **保存**：使用`CTRL+S`保存`gmapping.launch`文件。
- **编译**：在catkin工作空间目录下执行`catkin_make`进行编译。

**6. 运行Launch文件**

- **命令**：

  ```bash
  roslaunch slam_package gmapping.launch
  ```

**7. RViz配置**

- **添加显示**：
  1. 机器人模型。
  2. 激光雷达测距点。
  3. 地图数据。

**8. 保存RViz配置**

- **操作**：
  1. 在RViz中配置显示选项。
  2. 保存配置到`slam_package`的`rviz`文件夹中。
  3. 文件名为`gmapping.rviz`。

**9. 修改Launch文件以加载RViz配置**

- **步骤**：
  1. 在Launch文件的`<node>`标签中添加`<param>`标签。
  2. 设置参数`arguments`为`--display-config`后跟配置文件的路径。

**10. 运行完整的系统**

- **操作**：
  1. 运行修改后的Launch文件。
  2. 使用键盘控制节点移动机器人进行建图。

**11. 实体机器人上的运行**

- **步骤**：
  1. 替换Launch文件中的仿真环境启动指令为实体机器人的启动指令。
  2. 运行实体机器人上的gmapping。

**12. 后续内容预告**

- **预告**：下一节将介绍如何设置gmapping的建图参数。

**13. 总结**

- **成果**：通过编写和运行Launch文件，实现了gmapping SLAM建图的快速启动。
- **应用**：这种方法适用于仿真环境和实体机器人，提高了开发和测试的效率。



### 49. Gmapping的参数设置

**1. gmapping参数概览**

- **来源**：在ROS Wiki页面查找gmapping的参数列表。
- **分类**：
  1. 接口参数：与机器人坐标系相关的TF坐标系名称。
  2. 性能参数：影响算法性能和资源消耗的设置。
  3. 算法参数：深入调优gmapping算法的设置。

**2. 接口参数**

- **用途**：适配机器人的TF坐标系名称。

**3. 性能参数**

- **地图尺寸**：
  - 地图边界尺寸和分辨率影响内存占用。
- **激光雷达参数**：
  - `max_range`：激光雷达射线的最大有效距离。
  - `max_beams`：激光雷达射线的最大采纳数量。
  - `beam_skip`：扫描射线的跳过处理。
  - `odom_frame`：里程计的TF坐标系名称。
- **地图更新**：
  - `map_update_interval`：地图更新的最小时间间隔。
  - `linear_update`：地图更新的移动距离阈值。
  - `angular_update`：地图更新的旋转角度阈值。

**4. 定位参数**

- **粒子数**：`particles`，滤波器的粒子数，影响算力消耗。
- **重采样阈值**：`resample_threshold`，影响算力消耗。

**5. 参数设置方法**

- **操作**：在gmapping的Launch文件中使用`<param>`标签设置参数。

**6. 示例参数设置**

- **设置激光雷达最大有效距离**：

  ```xml
  <param name="max_range" value="3.0" />
  ```

- **设置地图更新间隔和移动距离阈值**：

  ```xml
  <param name="map_update_interval" value="0.5" />
  <param name="linear_update" value="0.1" />
  ```

**7. 运行修改后的Launch文件**

- **命令**：

  ```bash
  roslaunch slam_package gmapping.launch
  ```

**8. 观察效果**

- **激光雷达建图范围**：限制在设置的最大有效距离内。
- **地图更新频率**：随参数修改而变化。

**9. 后续学习建议**

- **尝试**：课后自行尝试调整其他参数。
- **深入**：后续深入探讨gmapping算法和参数优化。

**10. 总结**

- **gmapping**：通过调整参数可以优化SLAM性能和资源消耗。
- **操作流程**：了解参数分类，设置参数，运行Launch文件，观察效果。



### 50. 地图的保存和加载

**1. 保存地图**

- **软件包**：map_server
- **功能**：将地图保存到磁盘。

**2. 保存地图的步骤**

- **建图**：首先使用SLAM方法（如gmapping或hector_mapping）完成地图的构建。

- **保存命令**：

  ```bash
  rosrun map_server map_saver -f map
  ```

  - `-f` 参数后跟地图文件名前缀。

**3. 地图文件内容**

- **文件格式**：
  - `.map` 文件：包含地图的元数据和参数。
  - `.pgm` 文件：包含地图的图像数据。

**4. 地图文件详解**

- **.map 文件**：
  - `image`：指向地图图片文件（如 `map.pgm`）。
  - `resolution`：地图分辨率（米/像素）。
  - `origin`：地图左下角像素的坐标。
  - `negate`：地图相对于map坐标系的偏转角度。

**5. 加载地图**

- **功能**：将保存的地图文件加载回ROS环境中。

- **加载命令**：

  ```bash
  rosrun map_server map_server map.yaml
  ```

  - `map.yaml` 是保存时生成的地图参数文件。

**6. RViz中查看地图**

- **操作**：
  1. 启动RViz。
  2. 添加地图显示项目。
  3. 调整视角查看地图。

**7. 地图使用**

- **目的**：在后续的导航课程中使用加载的地图进行路径规划和导航。

**8. 注意事项**

- **保留文件**：保存的地图文件应在导航过程中保留，不要删除。

**9. 总结**

- **map_server**：用于保存和加载地图的ROS软件包。
- **操作流程**：完成SLAM建图后，使用map_server保存地图，需要时加载地图，并在RViz中查看。
