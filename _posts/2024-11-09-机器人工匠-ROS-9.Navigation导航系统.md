---
layout:     post
title:      ROS - 9.Navigation导航系统
subtitle:   机器人操作系统ROS快速入门教程
date:       2024-11-09
author:     Space
header-img: img/the-first.png
catalog:   true
tags:
    - ROS


---



# 机器人操作系统 ROS 

### 51. Navigation导航系统

**1. 导航系统架构**

- **人类导航类比**：使用地图APP进行定位和路径规划。
- **ROS导航架构**：包括全局规划器、局部规划器、地图服务器、定位器等组件。

**2. 导航过程**

- **获取地图**：从地图服务器下载地图数据。
- **定位**：确定当前位置。
- **路径规划**：设置目的地，生成导航路线。
- **执行**：沿着导航路线移动。
- **避障**：遇到障碍物时，生成临时路线绕过障碍。

**3. ROS导航组件**

- **Global Planner（全局规划器）**：生成全局导航路线。
- **Local Planner（局部规划器）**：控制机器人具体运动。
- **Map Server（地图服务器）**：提供地图数据。
- **AMCL（自适应蒙特卡洛定位器）**：提供机器人的实时定位。
- **Sensors（传感器）**：生成局部地图，用于避障。

**4. 导航中的挑战**

- **临时障碍物**：在移动过程中遇到的未知障碍物。
- **应急机制**：当无法绕过障碍物时，更新全局地图并重新规划路线。

**5. 导航决策流程**

- **主要逻辑**：包括路径规划、执行、避障和应急处理。
- **ROS实现**：下一节课将介绍如何在ROS中实现这一决策流程。

**6. 总结**

- **导航任务**：通过一系列决策和执行步骤，完成从起点到终点的移动。
- **ROS导航系统**：提供了一套完整的工具和算法，用于实现机器人的自主导航。



### 52. move_base节点

**1. 导航架构图解析**

- **组件形状**：
  - 矩形：代表独立节点（node）。
  - 椭圆形：代表内部组件。

**2. 核心组件**

- **move_base**：
  - 软件包名和节点名均为`move_base`。
  - 功能：连接全局规划器和局部规划器，维护两个地图。

**3. 输入数据需求**

- **map_server**：提供地图数据。
- **传感器节点**：仿真机器人自带，不需要额外配置。
- **里程计节点**：仿真机器人自带，不需要额外配置。
- **传感器位置的TF**：仿真机器人自带，不需要额外配置。
- **AMCL节点**：定位模块，需手动运行。

**4. 环境资源配置**

- **仿真环境**：使用`wpr_simulation`项目。
- **机器人驱动源码包**：包含导航参数文件。

**5. 地图准备**

- **使用已有地图**：如果之前已生成地图文件，直接使用。
- **建图操作**：如果没有地图，通过指定指令进行建图。
- **保存地图**：将建好的地图保存为文件。
- **复制地图文件**：将地图文件放入`wpr_simulation`的`maps`文件夹。

**6. 编写Launch文件**

- **创建软件包**：名为`nav_package`，包含导航依赖项。
- **新建Launch文件夹**：在`nav_package`中新建`launch`文件夹。
- **新建Launch文件**：在`launch`文件夹中创建`nav.launch`文件。

**7. 启动核心节点**

- **move_base节点**：设置参数，启动move_base节点。
- **map_server**：加载地图文件。
- **AMCL节点**：启动定位模块。

**8. 运行导航系统**

- **编译软件包**：确保`nav_package`编译无误。
- **运行仿真环境**：启动仿真环境。
- **运行Launch文件**：执行`roslaunch nav_package nav.launch`。

**9. 导航操作**

- **启动RViz**：显示地图和机器人位置。
- **设置目标点**：使用RViz的2D Goal工具设置导航目标点。
- **显示导航路线**：添加Path显示项目，显示机器人的导航路线。

**10. 总结**

- **导航实现**：通过配置环境资源、准备地图、编写并运行Launch文件，实现了ROS中的自主导航。
- **操作流程**：启动仿真环境和导航系统，设置目标点，观察机器人导航至目的地。



### **53. 全局规划器**

**笔记整理：ROS导航系统中的全局规划器设置**

**1. 导航系统与全局规划器**

- **导航架构**：包括导航目标点输入、全局规划器、局部规划器等。
- **全局规划器作用**：生成全局导航路线，类似于手机地图APP。

**2. 规划器选择**

- **多种规划器**：ROS Move Base 提供多种全局路径规划器。
- **算法类型**：
  - 广度优先算法：如Dijkstra算法。
  - 深度优先算法：如A*算法。

**3. ROS中的全局规划器**

- **三种预置规划器**：
  1. `navfn_planner`：早期的规划器，包含Dijkstra和A*算法。
  2. `global_planner`：性能优化版，无已知bug，推荐使用。
  3. `carrot_planner`：简单规划器，较少使用。

**4. 规划器参数设置**

- **设置方法**：在Move Base的Launch文件中设置`global_planner`参数。
- **默认算法**：Dijkstra算法，路径最优且平滑。

**5. 规划器参数详解**

- **资源**：ROS Wiki页面提供全局规划器的详细参数。
- **自定义规划器**：Move Base支持通过plugin接口编写自定义规划器。

**6. 规划器选择建议**

- **常规任务**：使用ROS自带的规划器足够。
- **特殊需求**：考虑自定义规划器，如扫地机器人、无人车路径规划。

**7. 总结**

- **全局规划器**：在ROS导航系统中生成从起点到终点的最优路径。
- **实现方法**：通过配置Move Base节点的参数来选择和设置规划器。
- **推荐规划器**：`global_planner`，性能优良且稳定。



### 54. AMCL定位算法

**1. 定位节点介绍**

- **名称**：AMCL（Adaptive Monte Carlo Localization）
- **功能**：使用粒子滤波在已知地图中进行定位。

**2. 定位原理**

- **粒子滤波**：通过撒出多个粒子（假设的位置和方向），模拟机器人可能的位置。
- **自我纠错**：通过与激光雷达和里程计数据的比对，淘汰不准确的粒子，保留最佳位置估计。

**3. 定位过程**

- **初始位置**：设置机器人的初始位置（推测位置，可能不准确）。
- **粒子分裂**：在机器人移动后，分裂出多个粒子，每个粒子代表一个可能的位置和方向。
- **比对和淘汰**：将激光雷达扫描的障碍物特征与地图比对，淘汰匹配效果差的粒子。
- **位置更新**：选择匹配效果最好的粒子作为新的位置估计。

**4. AMCL参数**

- **参数列表**：在ROS Wiki的AMCL页面中列出了所有参数。
- **设置方法**：可以在VS Code中打开特定的Launch文件进行参数设置。

**5. TF输出机制**

- **AMCL输出**：输出`map`到`odom`的TF。
- **里程计输出**：输出`base_link`到`odom`的TF。
- **组合**：形成`map`到`base_link`的完整TF关系。

**6. 定位效果观察**

- **RViz显示**：在RViz中添加粒子云（particle cloud）显示项目，订阅`particlecloud`话题。
- **粒子颜色**：设置为绿色，观察AMCL撒下的粒子（分身）。

**7. 定位过程中的TF突变**

- **TF突变**：AMCL在切换最佳粒子时，会在`map`到`odom`的TF上产生跳跃突变。
- **连续变化**：里程计输出的`odom`到`base_link`的TF通常保持连续变化。

**8. 后续应用**

- **代价地图生成**：TF突变特征在生成代价地图时会用到。

**9. 总结**

- **AMCL**：一种强大的定位节点，能够在已知地图中准确定位机器人。
- **操作流程**：设置初始位置，撒粒子，比对激光雷达数据，淘汰不准确粒子，更新位置。
- **参数设置**：通过ROS Wiki和Launch文件进行参数配置。
- **观察定位效果**：在RViz中观察粒子云和机器人位置的更新。



### 55. 代价地图 Costmap

**1. 代价地图的作用**

- **定义**：用于表示环境中障碍物的代价，影响机器人的导航路径。
- **组成**：
  - **全局代价地图**（Global Cost Map）：用于全局路径规划，考虑所有障碍物。
  - **局部代价地图**（Local Cost Map）：用于局部路径规划和避障，仅考虑机器人周围的障碍物。

**2. 代价地图的必要性**

- **全局与局部**：全局代价地图用于路径规划，局部代价地图用于实时避障。
- **性能考虑**：局部代价地图更新频率高，全局代价地图更新频率低。

**3. 代价地图的生成**

- **膨胀**：对障碍物进行膨胀处理，生成代价区域。
- **应用**：防止机器人过于靠近障碍物，确保安全。

**4. 观察代价地图**

- **RViz**：在RViz中添加代价地图显示项目，观察全局和局部代价地图。
- **配置**：
  - 全局代价地图：`global_costmap`话题，颜色方案为`cost_map`。
  - 局部代价地图：`local_costmap`话题，颜色方案为`cost_map`。

**5. 代价地图参数**

- **参数文件**：在Move Base的Launch文件中设置代价地图参数。
- **参数影响**：参数设置对导航效果有直接影响。

**6. RViz配置文件**

- **保存**：将RViz的显示配置保存为文件，方便后续使用。
- **加载**：在Launch文件中加载RViz配置文件。

**7. 导航测试**

- **设置目标点**：在RViz中设置导航目标点，测试导航效果。
- **观察**：全局规划器会避开代价区域，规划安全路径。

**8. 后续课程预告**

- **内容**：详细剖析代价地图参数的设置和影响。

**9. 总结**

- **代价地图**：在ROS导航中用于表示障碍物和风险区域，影响机器人的导航决策。
- **参数设置**：通过配置文件设置全局和局部代价地图的参数，以适应不同的导航需求。
- **观察与测试**：在RViz中观察代价地图，测试导航效果，确保机器人安全避障。



### 56. 代价地图的参数设置

**1. 代价地图简介**

- **全局代价地图**（Global Cost Map）：用于全局路径规划。
- **局部代价地图**（Local Cost Map）：用于局部路径规划和避障。

**2. 代价地图参数设置**

- **文件位置**：在Move Base的Launch文件中指定参数文件。

**3. 命名空间（NS）**

- **作用**：区分全局和局部代价地图的参数。
- **应用**：通过命名空间将参数应用到不同的代价地图。

**4. 参数文件内容**

- **`cost_map_common_params.yaml`**：
  - `robot_radius`：机器人半径。
  - `inflation_radius`：膨胀区域半径。
  - `observation_sources`：观测来源，如激光雷达。
  - `obstacle_range`：障碍物检测范围。
  - `raytrace_range`：光线追踪范围，用于清除动态障碍物的阴影。

**5. 观测来源参数**

- **数据类型**：激光雷达的数据类型。
- **话题名称**：激光雷达数据的话题。
- **`marking`**：是否将障碍物添加到代价地图。
- **`clearing`**：是否清除范围内的障碍物。

**6. 全局代价地图参数**

- **`global_cost_map_params.yaml`**：
  - `map_frame`：地图坐标系名称，通常为`map`。
  - `static_map`：是否使用来自Map Server的静态地图数据。
  - `update_frequency`：地图更新频率。
  - `publish_frequency`：地图发布频率。
  - `transform_tolerance`：TF变换容忍延迟。

**7. 局部代价地图参数**

- **`local_cost_map_params.yaml`**：
  - `global_frame`：全局坐标系名称，通常为`odom`。
  - `rolling_window`：局部地图是否随机器人移动。
  - `width`, `height`：局部地图的尺寸。
  - `update_frequency`：局部地图更新频率。

**8. 膨胀区域的作用**

- **`robot_radius`**：确保机器人不会碰撞的区域。
- **`inflation_radius`**：创建一个风险递增的区域，用于避障。

**9. 观测来源的扩展**

- **立体相机**：可以添加立体相机作为观测来源，用于检测桌面等平面障碍物。

**10. 参数设置的注意事项**

- **全局与局部地图**：全局地图用于路径规划，局部地图用于避障和精细控制。
- **性能考虑**：在性能有限的机器人上，适当调整参数以保证导航性能。

**11. 总结**

- **代价地图**：在ROS导航中用于表示障碍物和风险区域。
- **参数设置**：通过配置文件设置全局和局部代价地图的参数，以适应不同的导航需求。
- **观测来源**：可以根据机器人的传感器配置，添加不同的观测来源。



### 57. 恢复行为|Recovery Behaviors

**背景：**

- 机器人在导航时可能遇到动态障碍物，导致无法继续导航任务。
- 为了解决这一问题，引入了“恢复行为”（recovery behaviors）机制。

**恢复行为机制：**

1. **触发条件：** 当导航系统陷入停滞，无法找到有效路径时。
2. **目的：** 刷新障碍物信息，重新进行全局路径规划，以恢复导航。

**导航流程图：**

- **正常导航状态：** 机器人正常导航。
- **保守重置状态：** 清除地图中一定范围的障碍物信息，尝试重新规划导航路线。
  - **成功：** 恢复到正常导航状态。
  - **失败：** 进入旋转清除状态。
- **旋转清除状态：** 机器人原地旋转，用激光雷达扫描周围，刷新障碍物信息。
  - **成功：** 恢复到正常导航状态。
  - **失败：** 进入激进重置状态。
- **激进重置状态：** 清除更大范围的障碍物信息。
  - **成功：** 恢复到正常导航状态。
  - **失败：** 放弃导航任务。

**具体例子：**

- 场景：机器人前半部分区域可被激光雷达扫描，后半部分被遮挡。
- 障碍物：在门口放置障碍物，阻碍导航路线。
- 导航目标：设置导航目标点，尝试导航。

**恢复行为过程：**

1. **保守重置：** 清除3米范围内的障碍物信息，路径规划失败。
2. **旋转清除：** 机器人旋转一圈半，路径规划失败。
3. **激进重置：** 清除1.84米以外的障碍物信息，路径规划失败。
4. **第二次旋转清除：** 成功找到导航路线，脱困。

**问题与改进：**

- 存在的问题：保守重置和激进重置效果不明显，依赖旋转清除。
- 改进方向：可以重新编排恢复行为流程，增加新的行为状态，根据机器人特性和任务需求设计恢复行为机制。

**总结：**
恢复行为机制对于存在激光雷达盲区的机器人尤为重要，通过旋转清除消除盲区内的障碍物残影，找到新的导航路线，帮助机器人顺利脱困。尽管存在一些问题，但整个流程和机制是可以调整和优化的。



### 58. 恢复行为的参数设置

**恢复行为默认流程：**

- 包含两种行为类型：
  - **重置行为** (`clear custom recovery`)
  - **旋转清除行为** (`rotate recovery`)
- 还有一个不常用的行为类型：
  - **mooof slow and clear**（易碰撞障碍物）

**参数设置步骤：**

1. 在VS Code中打开参数文件。
2. 恢复行为主要为全局路径规划服务，参数写在全局代价地图的参数文件中。

**新的恢复行为流程：**

1. **旋转清除**：首先尝试旋转清除。
2. **重置清除**：如果旋转清除失败，则启动重置清除。

**参数设置细节：**

- **Recovery behaviors**：指定参数生效的空间。
- **行为列表**：
  - **Name**：行为的名称，可以自定义。
  - **Type**：行为的类型，从三种预设类型中选择。

**地图的分层结构：**

- **Static地图**：静态地图层。
- **Obstacles地图**：动态障碍物层。
- **Inflation地图**：膨胀层，障碍物边缘设置缓冲区。
- **Master地图**：最终的代价地图，由下三层合并而成。

**重置行为的工作内容：**

- 清除激光雷达过去探测到的障碍物信息。
- 刷新障碍物信息，用于重新路径规划。

**障碍物清除范围：**

- 以机器人为中心，构建一个正方形区域。
- **Reet distance**：正方形的边长，单位是米。

**参数测试：**

- 将清除范围设为0，清除障碍层的所有信息。
- 测试新的恢复行为是否按照设计的流程运行。

**参数设置注意事项：**

- **Layer names**：指定要清除的地图层。
- **默认值问题**：
  - `clear cost map recovery` 的默认层名是 `obstacles`。
  - `map` 的默认层名是 `obstacle layer`。
- 需要确保这两个名称一致，否则重置行为无法正常清除障碍物。

**更多参数信息：**

- 可在ROS的wiki页面搜索 `rotate recovery` 和 `clear cost map recovery` 查看详细参数列表。

**总结：**

- 通过设置参数，可以自定义恢复行为的流程和效果。
- 注意地图层名称的一致性，以确保恢复行为能够正确执行。
- 测试和调整参数，以优化机器人的导航和脱困能力。



### 59. 局部规划器|Local Planner

**局部规划器的作用：**

- 接收全局规划器生成的路线。
- 根据实际路况和机器人底盘的运动特性操纵机器人移动。
- 对导航效果至关重要。

**局部规划器的重要性：**

- 即使有好的全局规划，局部规划器执行不当也可能导致导航失败或机器损伤。

**局部规划器的选择：**

- 可以自行开发或选择现成的开源规划器。
- 开源规划器例子：
  - ROS自带：`trajectory planner` 和 `dwa planner`
  - 第三方：`1BAND planner` 和 `TB planner`
  - 课程使用：`w BH local planner`

**局部规划器的安装与使用：**

- 在`launch`文件中修改`move base`的`base_local_planner`参数。
- 指定`w BH local planner`，使用针对特定机器人优化的局部规划器。

**`w BH local planner`原理：**

- 利用激光雷达采集的障碍点信息。
- 局部规划器内部实现基于A*算法。
- 使用人工势场方法绕过障碍物。
- 控制策略保守，追求运动行为的确定性。

**局限性：**

- 针对特定机器人深度优化，不具备通用性。

**其他局部规划器：**

- `trajectory planner`：ROS默认局部规划器，使用`dwa`算法。
- `dwa planner`：代码质量更高，运行效率更好，常替换`trajectory planner`。
- `1BAND planner`和`TB planner`：
  - `1BAND planner`：考虑实时因素，提供代价地图优化插件。
  - `TB planner`：运动平滑性和执行效率更高。

**后续课程：**

- 体验`dwa`和`TB`局部规划器。
- 通过仿真环境对比优缺点。

**总结：**

- 局部规划器是实现有效导航的关键环节。
- 选择合适的局部规划器可以显著提升导航性能和安全性。
- 通过实际测试和参数调整，可以找到最适合特定机器人的局部规划器。



### 60. DWA规划器

**本节课内容：**

- 深入学习DWA（Dynamic Window Approach）规划器。

**DWA规划器概述：**

- **名称含义**：动态窗口方法。
- **窗口定义**：指机器人运动控制中可能的轨迹和速度的空间。
- **算法目的**：从可能的轨迹和速度中选择最合适的一条来驱动机器人。

**DWA算法核心内容：**

1. **轨迹生成**：
   - 基于当前速度，规划未来运动状态和线路。
   - 考虑速度分量（线速度和角速度）的不同组合。
   - 采样速度值，考虑加速度限制、刹车距离和快速到达终点。
2. **轨迹选择**：
   - 贴合导航路线。
   - 终点与目标点的距离。
   - 轨迹与障碍物的距离。

**DWA算法特点：**

- 轨迹以平滑弧线为主。
- 不一定完全贴合全局路线。

**DWA在ROS中的使用：**

1. 修改`move_base`的`base_local_planner`参数为DWA。
2. 加载DWA参数文件。
3. 保存并运行导航。

**DWA显示设置：**

- 在RViz中添加路径显示项目。
- 调整线条样式和话题名称。

**DWA参数调节：**

- 参数文件通常位于`~/catkin_ws/src/your_project/`目录。
- 参数分为速度参数、目标容差、向前模拟、轨迹评分、防震荡、显示选项等。
- 参数详细说明可在ROS Wiki的DWA页面找到。

**在线调参工具：**

- 使用`rqt_reconfigure`动态调整参数。
- 实时观察调整效果并保存新参数。

**DWA参数细节：**

- **关键参数**：全局路径贴合权重、终点距离权重、障碍物距离权重。
- **争议参数**：最小X方向速度（控制机器人是否倒车）。

**DWA使用注意事项：**

- 考虑机器人的雷达视野，避免在无视野区域倒车。
- 避免机器人进入危险区域。

**总结：**

- DWA规划器通过动态窗口方法生成和选择轨迹。
- 参数调节对导航效果有显著影响。
- 在线调参工具`rqt_reconfigure`提供了便捷的参数调整方式。



### 61. TEB规划器

**本节课内容：**

- 介绍另一个著名规划器：TEB（Time-Elastic Band）。

**TEB规划器原理：**

- **时间弹力带（TEB）**：在全局路径上优化一段路径，像弹力带一样受全局路径吸引力和障碍物排斥力影响。
- **时间预测**：根据机器人速度和加速度预测未来位置，选择运动最快的路线。
- **应用场景**：常用于竞速比赛。

**TEB规划器在ROS中的使用：**

1. TEB规划器不是ROS官方导航组件，需要额外安装。
2. 安装命令：`sudo apt-get install ros-noetic-teb-local-planner`。
3. 修改`move_base`的`base_local_planner`参数为TEB规划器。
4. 修改局部规划器参数文件为TEB的参数文件。

**TEB规划器显示设置：**

- 在RViz中添加显示项目，如局部路径和预测位置。
- 调整线条风格和话题名称以清晰显示。

**TEB规划器特点：**

- 具有强大的脱困能力。
- 适合Ackerman驱动的机器人，不擅长原地旋转。

**TEB规划器参数调节：**

- 参数文件通常位于`~/catkin_ws/src/your_project/`目录。
- 参数包括轨迹生成策略、运动性能、避碰、优化等。
- 参数详细解释可在ROS Wiki的TEB页面找到。

**在线调参工具：**

- 使用`rqt_reconfigure`进行在线调参。
- 调整参数后，可将新数值保存到参数文件中。

**TEB规划器参数细节：**

- 参数众多，与算法细节紧密相关。
- 包含一个`Costmap Converter`插件，可提高规划性能和避障效果。

**总结：**

- TEB规划器提供了强大的路径规划和避障能力。
- 参数调节需要对算法有一定理解，建议阅读相关论文。
- 默认参数适用于简单应用，深入应用需要详细调参。

**建议：**

- 根据需要选择是否深入研究TEB规划器。
- 对于复杂应用，建议深入阅读论文并进行详细调参。
